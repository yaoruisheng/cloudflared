--- a/connection/http2.go
+++ b/connection/http2.go
@@ -112,7 +112,8 @@
 		requestErr = c.handleConfigurationUpdate(respWriter, r)
 
 	case TypeWebsocket, TypeHTTP:
-		stripWebsocketUpgradeHeader(r)
+		// [Headscale Fix] Do not strip the internal upgrade header here
+		// stripWebsocketUpgradeHeader(r)
 		// Check for tracing on request
 		tr := tracing.NewTracedHTTPRequest(r, c.connIndex, c.log)
 		if err := originProxy.ProxyHTTP(respWriter, tr, connType == TypeWebsocket); err != nil {
@@ -326,7 +327,8 @@
 }
 
 func stripWebsocketUpgradeHeader(r *http.Request) {
-	r.Header.Del(InternalUpgradeHeader)
+	// [Headscale Fix] Prevent stripping the internal upgrade header
+	// r.Header.Del(InternalUpgradeHeader)
 }
 
 // getRequestHost returns the host of the http.Request.

--- a/proxy/proxy.go
+++ b/proxy/proxy.go
@@ -165,8 +165,14 @@
 		roundTripReq.Header.Set("Connection", "Upgrade")
 		roundTripReq.Header.Set("Upgrade", "websocket")
 		roundTripReq.Header.Set("Sec-Websocket-Version", "13")
-		roundTripReq.ContentLength = 0
-		roundTripReq.Body = nil
+
+		// [Headscale Fix] Allow POST/PUT/etc. to keep their body during upgrade
+		if tr.Request.Method == http.MethodGet || tr.Request.Method == http.MethodHead {
+			roundTripReq.ContentLength = 0
+			roundTripReq.Body = nil
+		} else {
+			roundTripReq.ContentLength = tr.Request.ContentLength
+			roundTripReq.Body = tr.Request.Body
+		}
 	} else {
 		// Support for WSGI Servers by switching transfer encoding from chunked to gzip/deflate
 		if disableChunkedEncoding {

--- a/carrier/websocket.go
+++ b/carrier/websocket.go
@@ -91,7 +91,8 @@
 	}
 	// Assume the header keys are in canonical format.
 	for _, header := range stripWebsocketHeaders {
-		wsHeaders.Del(header)
+		// [Headscale Fix] Do not strip standard websocket headers for non-standard upgrades
+		// wsHeaders.Del(header)
 	}
 	wsHeaders.Set("Host", req.Host) // See TUN-1097
 	return wsHeaders
