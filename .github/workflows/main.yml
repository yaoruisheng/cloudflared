name: Build Cloudflared (Official Naming & Legacy Go)

on:
  workflow_dispatch:
    inputs:
      version:
        description: '发布版本号'
        required: true
        default: '2026.2.0'
      arch:
        description: '目标架构'
        required: true
        default: 'arm64'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1️⃣ 检出官方源码
      - name: Checkout cloudflared
        uses: actions/checkout@v4
        with:
          repository: cloudflare/cloudflared
          ref: ${{ github.event.inputs.version }}
          fetch-depth: 0

      # 2️⃣ 安装环境依赖 (对齐 Makefile 需求)
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make capnproto libcapnp-dev ruby ruby-dev rubygems build-essential rpm
          sudo gem install --no-document fpm

      # 3️⃣ 安装你指定的自定义 Legacy Go (解决 syscall 问题)
      - name: Install Your Custom Legacy Go
        run: |
          curl -L -o go.tar.gz https://github.com/yaoruisheng/go/releases/download/go-legacy-amd64-14/go-legacy-amd64.tar.gz
          mkdir -p $HOME/custom_go
          tar -xzf go.tar.gz -C $HOME/custom_go --strip-components=1
          echo "GOROOT=$HOME/custom_go" >> $GITHUB_ENV
          echo "PATH=$HOME/custom_go/bin:$PATH" >> $GITHUB_ENV

      # 4️⃣ 安装 Makefile 必需插件
      - name: Install Go Tools
        run: |
          go install capnproto.org/go/capnp/v3/capnpc-go@latest

      # 5️⃣ 编译与命名优化 (将 Debian 标准名转换为官方发布名)
      - name: Build and Prepare Official Assets
        id: prep
        run: |
          VERSION=${{ github.event.inputs.version }}
          ARCH=${{ github.event.inputs.arch }}
          
          # 设定交叉编译变量
          export GOOS=linux
          export GOARCH=$ARCH
          export CGO_ENABLED=0
          
          # 执行 Makefile 编译二进制和生成 DEB
          make cloudflared VERSION="$VERSION"
          make cloudflared-deb VERSION="$VERSION"
          
          # --- 重命名为 Cloudflare 官方发布风格 ---
          # 1. 二进制：cloudflared -> cloudflared-linux-arm64
          BINARY_NAME="cloudflared-linux-$ARCH"
          mv cloudflared $BINARY_NAME
          
          # 2. DEB包：cloudflared_2026.2.0_arm64.deb -> cloudflared-linux-arm64.deb
          DEB_TEMP=$(ls *.deb)
          DEB_NAME="cloudflared-linux-$ARCH.deb"
          mv "$DEB_TEMP" "$DEB_NAME"
          
          # 输出给后续步骤使用
          echo "BINARY=$BINARY_NAME" >> $GITHUB_OUTPUT
          echo "DEB=$DEB_NAME" >> $GITHUB_OUTPUT

      # 6️⃣ 使用原生 Action 发布到 GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: ${{ github.event.inputs.version }}
          files: |
            ${{ steps.prep.outputs.BINARY }}
            ${{ steps.prep.outputs.DEB }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7️⃣ 上传 Artifact 备份 (Action 页面可下载)
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cloudflared-build-${{ github.event.inputs.arch }}
          path: |
            ${{ steps.prep.outputs.BINARY }}
            ${{ steps.prep.outputs.DEB }}
