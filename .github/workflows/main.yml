name: Build Cloudflared (Official Naming & Legacy Go)

on:
  workflow_dispatch:
    inputs:
      version:
        description: '发布版本号'
        required: true
        default: '2026.2.0'
      arch:
        description: '目标架构'
        required: true
        default: 'arm64'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1️⃣ 检出官方源码到主目录 (.)
      - name: Checkout cloudflared
        uses: actions/checkout@v4
        with:
          repository: cloudflare/cloudflared
          ref: ${{ github.event.inputs.version }}
          fetch-depth: 0

      # 2️⃣ 检出你自己的仓库到临时目录 (tmp_patches)
      - name: Checkout custom patches
        uses: actions/checkout@v4
        with:
          path: tmp_patches

      # 3️⃣ 应用补丁 (通过重写函数确保 100% 成功)
      - name: Apply Headscale Patches
        run: |
          echo "=== 开始物理注入 Headscale 补丁 ==="

          # 1. 注入 connection/http2.go (放行 101)
          # 我们直接清空这个函数里的状态码强制转换逻辑
          python3 -c '
          import os
          path = "connection/http2.go"
          content = open(path).read()
          # 移除 101 -> 200 的转换
          content = content.replace("if status == http.StatusSwitchingProtocols {\n\t\tstatus = http.StatusOK\n\t}", "// Status 101 Preserved")
          # 修复 stripWebsocketUpgradeHeader
          import re
          content = re.sub(r"func stripWebsocketUpgradeHeader\(r \*http\.Request\) \{.*?\}", "func stripWebsocketUpgradeHeader(r *http.Request) {\n\treturn\n}", content, flags=re.DOTALL)
          with open(path, "w") as f: f.write(content)
          '

          # 2. 注入 proxy/proxy.go (恢复 Body 和 清理 Header)
          # 使用 Python 处理多行替换，避免 sed 的语法陷阱
          python3 -c '
          import os
          path = "proxy/proxy.go"
          content = open(path).read()
          # 恢复 ContentLength 和 Body
          content = content.replace("roundTripReq.ContentLength = 0", "roundTripReq.ContentLength = tr.Request.ContentLength")
          content = content.replace("roundTripReq.Body = nil", "roundTripReq.Body = tr.Request.Body")
          # 注入关键 Header 处理
          old_line = "resp, err := httpService.RoundTrip(roundTripReq)"
          new_logic = """if isWebsocket {
          \t\troundTripReq.Header.Del("Cf-Cloudflared-Proxy-Connection-Upgrade")
          \t\troundTripReq.Header.Set("Connection", "Upgrade")
          \t\troundTripReq.Header.Set("Upgrade", "websocket")
          \t}
          \tresp, err := httpService.RoundTrip(roundTripReq)"""
          content = content.replace(old_line, new_logic)
          with open(path, "w") as f: f.write(content)
          '

          # 3. 注入 carrier/websocket.go (放行响应头)
          sed -i '/stripWebsocketHeaders/,/}/d' carrier/websocket.go

          echo "=== 注入完成，开始编译 ==="

      # 4️⃣ 安装环境依赖 (对齐 Makefile 需求)
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make capnproto libcapnp-dev ruby ruby-dev rubygems build-essential rpm
          sudo gem install --no-document fpm

      # 5️⃣ 安装你指定的自定义 Legacy Go (解决 syscall 问题)
      - name: Install Your Custom Legacy Go
        run: |
          curl -L -o go.tar.gz https://github.com/yaoruisheng/go/releases/download/go-legacy-amd64-14/go-legacy-amd64.tar.gz
          mkdir -p $HOME/custom_go
          tar -xzf go.tar.gz -C $HOME/custom_go --strip-components=1
          echo "GOROOT=$HOME/custom_go" >> $GITHUB_ENV
          echo "PATH=$HOME/custom_go/bin:$PATH" >> $GITHUB_ENV

      # 6️⃣ 安装 Makefile 必需插件
      - name: Install Go Tools
        run: |
          go install capnproto.org/go/capnp/v3/capnpc-go@latest

      # 7️⃣ 编译与命名优化 (路径与你原始版本完全一致)
      - name: Build and Prepare Official Assets
        id: prep
        run: |
          VERSION=${{ github.event.inputs.version }}
          ARCH=${{ github.event.inputs.arch }}
          export GOOS=linux
          export GOARCH=$ARCH
          export CGO_ENABLED=0
          
          make cloudflared VERSION="$VERSION"
          make cloudflared-deb VERSION="$VERSION"
          
          BINARY_NAME="cloudflared-linux-$ARCH"
          mv cloudflared $BINARY_NAME
          
          DEB_TEMP=$(ls *.deb)
          DEB_NAME="cloudflared-linux-$ARCH.deb"
          mv "$DEB_TEMP" "$DEB_NAME"
          
          echo "BINARY=$BINARY_NAME" >> $GITHUB_OUTPUT
          echo "DEB=$DEB_NAME" >> $GITHUB_OUTPUT

      # 8️⃣ 发布到 GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: ${{ github.event.inputs.version }}
          files: |
            ${{ steps.prep.outputs.BINARY }}
            ${{ steps.prep.outputs.DEB }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 9️⃣ 上传 Artifact 备份
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cloudflared-build-${{ github.event.inputs.arch }}
          path: |
            ${{ steps.prep.outputs.BINARY }}
            ${{ steps.prep.outputs.DEB }}
