name: Build Cloudflared (Official Naming & Legacy Go)

on:
  workflow_dispatch:
    inputs:
      version:
        description: '发布版本号'
        required: true
        default: '2026.2.0'
      arch:
        description: '目标架构'
        required: true
        default: 'arm64'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1️⃣ 检出官方源码到主目录 (.)
      - name: Checkout cloudflared
        uses: actions/checkout@v4
        with:
          repository: cloudflare/cloudflared
          ref: ${{ github.event.inputs.version }}
          fetch-depth: 0

      # 2️⃣ 检出你自己的仓库到临时目录 (tmp_patches)
      - name: Checkout custom patches
        uses: actions/checkout@v4
        with:
          path: tmp_patches

      # 3️⃣ 应用补丁 (使用 -p1 模式)
      - name: Apply Headscale Patches
        run: |
          # 确保在 cloudflared 源码根目录下运行
          
          # 清理编码
          #find . -type f -name "*.go" -exec sed -i 's/\xc2\xa0/ /g' {} +
          # 打补丁
          patch -p1 --ignore-whitespace < tmp_patches/patches/allow-upgrade-with-body.patch
          echo "=== 物理一致性检查 (严格模式) ==="
          
          # 1. 检查客户端是否具备嗅探能力
          echo "检查 carrier/carrier.go..."
          grep "time.Millisecond \* 30" carrier/carrier.go || { echo "❌ 缺失预读逻辑"; exit 1; }
          grep "readWriterWrapper" carrier/carrier.go || { echo "❌ 缺失流缝合包装器"; exit 1; }

          # 2. 检查客户端是否发送 Body
          echo "检查 carrier/websocket.go..."
          grep "method := http.MethodPost" carrier/websocket.go || { echo "❌ 缺失 POST 转换逻辑"; exit 1; }
          grep -C 5 "stripWebsocketHeaders" carrier/websocket.go | grep "//" || { echo "❌ Header 过滤未解除"; exit 1; }

          # 3. 检查服务端是否转发 Body (修复 500 关键)
          echo "检查 proxy/proxy.go..."
          grep -C 2 "roundTripReq.Body = nil" proxy/proxy.go | grep "//" || { echo "❌ 发现 Body 清空残留，服务端仍会丢包"; exit 1; }
          grep "Cf-Cloudflared-Proxy-Connection-Upgrade" proxy/proxy.go || { echo "❌ 缺失 WS 头部补全逻辑"; exit 1; }

          # 4. 检查传输层透传
          echo "检查 connection/http2.go..."
          grep -C 2 "StatusSwitchingProtocols" connection/http2.go | grep "//" || { echo "❌ 101 状态码仍被强制改写"; exit 1; }

          echo "✅ [SUCCESS] 全链路补丁对齐，准许编译。"  
          # 清理临时目录
          rm -rf tmp_patches
          echo "Patches applied successfully using patch -p1."
          #exit 1

      # 4️⃣ 安装环境依赖 (对齐 Makefile 需求)
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make capnproto libcapnp-dev ruby ruby-dev rubygems build-essential rpm
          sudo gem install --no-document fpm

      # 5️⃣ 安装你指定的自定义 Legacy Go (解决 syscall 问题)
      - name: Install Your Custom Legacy Go
        run: |
          curl -L -o go.tar.gz https://github.com/yaoruisheng/go/releases/download/go-legacy-amd64-14/go-legacy-amd64.tar.gz
          mkdir -p $HOME/custom_go
          tar -xzf go.tar.gz -C $HOME/custom_go --strip-components=1
          echo "GOROOT=$HOME/custom_go" >> $GITHUB_ENV
          echo "PATH=$HOME/custom_go/bin:$PATH" >> $GITHUB_ENV

      # 6️⃣ 安装 Makefile 必需插件
      - name: Install Go Tools
        run: |
          go install capnproto.org/go/capnp/v3/capnpc-go@latest

      # 7️⃣ 编译与命名优化 (路径与你原始版本完全一致)
      - name: Build and Prepare Official Assets
        id: prep
        run: |
          VERSION=${{ github.event.inputs.version }}
          ARCH=${{ github.event.inputs.arch }}
          export GOOS=linux
          export GOARCH=$ARCH
          export CGO_ENABLED=0
          
          make cloudflared VERSION="$VERSION"
          make cloudflared-deb VERSION="$VERSION"
          
          BINARY_NAME="cloudflared-linux-$ARCH"
          mv cloudflared $BINARY_NAME
          
          DEB_TEMP=$(ls *.deb)
          DEB_NAME="cloudflared-linux-$ARCH.deb"
          mv "$DEB_TEMP" "$DEB_NAME"
          
          echo "BINARY=$BINARY_NAME" >> $GITHUB_OUTPUT
          echo "DEB=$DEB_NAME" >> $GITHUB_OUTPUT

      # 8️⃣ 发布到 GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: ${{ github.event.inputs.version }}
          files: |
            ${{ steps.prep.outputs.BINARY }}
            ${{ steps.prep.outputs.DEB }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 9️⃣ 上传 Artifact 备份
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cloudflared-build-${{ github.event.inputs.arch }}
          path: |
            ${{ steps.prep.outputs.BINARY }}
            ${{ steps.prep.outputs.DEB }}
